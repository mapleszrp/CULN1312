<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Lethality Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Add styles for active tab */
        .tab.active {
            border-color: #3b82f6; /* blue-500 */
            color: #2563eb; /* blue-600 */
        }
    </style>
</head>
<!-- 
  BUG FIX: Removed 'h-full flex items-center justify-center' from body tag.
  This was preventing scrolling when the graph was generated, as it tries to
  vertically center the content. 'py-12' provides top/bottom padding instead.
-->
<body class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-lg">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                Process Lethality Calculator
            </h1>
            <p class="text-gray-600 mb-6">
                Use this tool to determine the total log reductions for your thermal process.
            </p>
        </div>

        <!-- Step 1: Input Parameters -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 1: Enter Your Process Parameters</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="t_ref" class="block text-sm font-medium text-gray-700">Reference Temp (T<sub>ref</sub>) in 째C</label>
                    <input type="number" id="t_ref" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="d_val" class="block text-sm font-medium text-gray-700">D-value (D) at T<sub>ref</sub> (in min)</label>
                    <input type="number" id="d_val" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="z_val" class="block text-sm font-medium text-gray-700">Z-value (Z) in 째C</label>
                    <input type="number" id="z_val" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="target_log" class="block text-sm font-medium text-gray-700">Target Log Reduction</label>
                    <input type="number" id="target_log" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Step 2: Input Data -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 2: Input Your Time-Temperature Data</h2>
            <p class="text-sm text-gray-600 mb-4">Enter your data logger time <em>interval</em> (in seconds) here.</p>
            <div>
                <label for="interval" class="block text-sm font-medium text-gray-700">Time Interval (in seconds)</label>
                <input type="number" id="interval" value="1" class="mt-1 block w-48 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>

            <!-- Tabs for data input -->
            <div class="mt-4 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-paste" class="tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" onclick="showTab('paste')">Paste from Excel/CSV</button>
                    <button id="tab-manual" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showTab('manual')">Enter Manually</button>
                </nav>
            </div>

            <!-- Tab Content 1: Paste Data -->
            <div id="content-paste" class="tab-content active mt-4">
                <p class="text-sm text-gray-600 mb-2">Paste your column of temperature data below. <em>Only include temperatures (in 째C)</em>, one per line. Omit time, headers, or any other text.</p>
                <textarea id="data_paste" rows="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm" placeholder="7.1&#10;7.8&#10;8.9&#10;10.2&#10;12.5&#10;..."></textarea>
            </div>

            <!-- Tab Content 2: Manual Data -->
            <div id="content-manual" class="tab-content mt-4 hidden">
                <p class="text-sm text-gray-600 mb-2">Enter temperatures (째C) separated by commas.</p>
                <textarea id="data_manual" rows="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm" placeholder="7.1, 7.8, 8.9, 10.2, 12.5, ..."></textarea>
            </div>
        </div>
       
        <button id="calculate_btn" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Calculate Lethality
        </button>

        <!-- Step 3: Results -->
        <div id="results" class="hidden mt-6 bg-green-50 border border-green-200 rounded-lg p-6 shadow-lg">
            <!-- 
                FIX: Added an ID 'results_title' to this h2 tag 
                to allow for color swapping on fail.
            -->
            <h2 id="results_title" class="text-2xl font-bold text-green-800 mb-4">Calculation Complete</h2>
            <div class="text-center">
                <p class="text-lg text-gray-700">Cumulative Log Reductions Achieved:</p>
                <p id="result_log" class="text-6xl font-extrabold text-green-700 my-2">0.00</p>
                <p class="text-gray-600 text-sm">(Calculated from a Total Lethal Effect F-value of <span id="result_f" class="font-medium text-gray-800">0.00</span> minutes)</p>
                <p id="result_summary" class="text-gray-600 mt-2"></p>
                <p id="result_conclusion" class="text-lg font-semibold mt-4"></p>
            </div>
        </div>

        <!-- NEW: Chart Container -->
        <div id="chartContainer" class="hidden mt-6 bg-white shadow-lg rounded-lg p-6 border border-gray-200">
            <!--<h2 class="text-xl font-semibold text-gray-700 mb-4">Process Lethality Over Time</h2>-->
            <canvas id="lethalityChart"></canvas>
        </div>

        <div id="error" class="hidden mt-6 bg-red-50 border border-red-200 rounded-lg p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-red-800 mb-4">Error</h2>
            <p id="error_message" class="text-red-700"></p>
        </div>

        <!-- Footer for spacing -->
        <div class="h-16"></div> 
    </div>

    <script>
        // Global variable to hold the chart instance
        let myLethalityChart = null;
        let activeTab = 'paste'; // Default to paste tab

        // --- FIX: Added showTab function ---
        function showTab(tabName) {
            activeTab = tabName;

            // Hide all tab content
            document.getElementById('content-paste').classList.add('hidden');
            document.getElementById('content-manual').classList.add('hidden');
            
            // Deactivate all tab buttons
            const pasteTab = document.getElementById('tab-paste');
            pasteTab.classList.remove('active', 'border-blue-500', 'text-blue-600');
            pasteTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            const manualTab = document.getElementById('tab-manual');
            manualTab.classList.remove('active', 'border-blue-500', 'text-blue-600');
            manualTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

            // Show the active tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            // Activate the active tab button
            const activeButton = document.getElementById(`tab-${tabName}`);
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        }
        // --- End of FIX ---

        document.getElementById('calculate_btn').addEventListener('click', function() {
            try {
                // 1. Get All Parameters
                const t_ref = parseFloat(document.getElementById('t_ref').value);
                const d_val = parseFloat(document.getElementById('d_val').value);
                const z_val = parseFloat(document.getElementById('z_val').value);
                const interval_sec = parseFloat(document.getElementById('interval').value);
                const target_log = parseFloat(document.getElementById('target_log').value);
                
                if (isNaN(t_ref) || isNaN(d_val) || isNaN(z_val) || isNaN(interval_sec) || isNaN(target_log) || d_val <= 0 || z_val <= 0 || interval_sec <= 0 || target_log <= 0) {
                    throw new Error("Invalid parameters. Please check all values. They must be positive numbers and not empty.");
                }

                // Convert interval to minutes
                const delta_t = interval_sec / 60.0;

                // --- FIX: Get data from the active tab ---
                let temp_data_string = '';
                if (activeTab === 'paste') {
                    temp_data_string = document.getElementById('data_paste').value;
                } else {
                    temp_data_string = document.getElementById('data_manual').value;
                }
                // --- End of FIX ---
                
                if (!temp_data_string) {
                    throw new Error("Temperature data cannot be empty.");
                }
                const temps = temp_data_string.split(/[\s\n,]+/).filter(Boolean).map(Number); // Added \n to split
                if (temps.some(isNaN)) {
                    throw new Error("Temperature data contains non-numeric values. Please check your pasted data.");
                }

                // 3. Perform Calculation
                let timeLabels = [];
                let cumulativeLogReductions = [];
                let targetLogData = [];
                let cumulativeF = 0;
                let cumulativeLog = 0;

                temps.forEach((temp, index) => {
                    // Formula: L = 10 ^ ((T - T_ref) / Z)
                    const lethal_rate = Math.pow(10, (temp - t_ref) / z_val);
                    
                    // F = Sum(L * delta_t)
                    cumulativeF += (lethal_rate * delta_t);
                    
                    // Log Reductions = F / D_ref
                    cumulativeLog = cumulativeF / d_val;

                    // Store data for the graph
                    cumulativeLogReductions.push(cumulativeLog.toFixed(2));
                    targetLogData.push(target_log);
                    // Calculate time in minutes and format to avoid long decimals
                    const timeInMinutes = ((index + 1) * interval_sec) / 60.0;
                    // Round to 2 decimal places for cleaner display, but keep enough precision for calculations
                    timeLabels.push(`${timeInMinutes.toFixed(2)} min`);
                });

                const log_reductions = cumulativeLog;
                const total_f = cumulativeF;

                // 4. Display Results
                document.getElementById('result_log').textContent = log_reductions.toFixed(2);
                document.getElementById('result_f').textContent = total_f.toFixed(2);
                document.getElementById('result_summary').textContent = `Based on ${temps.length} data points at ${interval_sec}-second intervals.`;
                
                let conclusion = "";
                let isSafe = log_reductions >= target_log;
                
                // --- FIX: Grab the results_title element ---
                const resultsTitle = document.getElementById('results_title');

                if (isSafe) {
                    conclusion = `PROCESS IS SAFE. You have achieved your target ${target_log}-log reduction.`;
                    // Set results box to GREEN
                    document.getElementById('results').classList.remove('bg-red-50', 'border-red-200');
                    document.getElementById('results').classList.add('bg-green-50', 'border-green-200');
                    // Set title to GREEN
                    resultsTitle.classList.remove('text-red-800');
                    resultsTitle.classList.add('text-green-800');
                    // Set log number to GREEN
                    document.getElementById('result_log').classList.remove('text-red-700');
                    document.getElementById('result_log').classList.add('text-green-700');
                    // Set conclusion text to GREEN
                    document.getElementById('result_conclusion').classList.remove('text-red-700');
                    document.getElementById('result_conclusion').classList.add('text-green-700');
                } else {
                    conclusion = `PROCESS IS NOT YET SAFE. Target is ${target_log}-log. Your process must be adjusted (e.g., increase time or temperature).`;
                    // Set results box to RED
                    document.getElementById('results').classList.remove('bg-green-50', 'border-green-200');
                    document.getElementById('results').classList.add('bg-red-50', 'border-red-200');
                    // Set title to RED
                    resultsTitle.classList.remove('text-green-800');
                    resultsTitle.classList.add('text-red-800');
                     // Set log number to RED
                    document.getElementById('result_log').classList.remove('text-green-700');
                    document.getElementById('result_log').classList.add('text-red-700');
                    // Set conclusion text to RED
                    document.getElementById('result_conclusion').classList.remove('text-green-700');
                    document.getElementById('result_conclusion').classList.add('text-red-700');
                }
                document.getElementById('result_conclusion').textContent = conclusion;

                document.getElementById('results').classList.remove('hidden');
                document.getElementById('error').classList.add('hidden');

                // 5. Create or Update Graph
                const ctx = document.getElementById('lethalityChart').getContext('2d');
                
                // Destroy previous chart instance if it exists
                if (myLethalityChart) {
                    myLethalityChart.destroy();
                }

                myLethalityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeLabels,
                        datasets: [
                        {
                            label: 'Actual Log Reductions',
                            data: cumulativeLogReductions,
                            borderColor: isSafe ? 'rgb(22, 163, 74)' : 'rgb(220, 38, 38)',
                            backgroundColor: isSafe ? 'rgba(22, 163, 74, 0.1)' : 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 3,
                            fill: true, // Keep the area fill
                            tension: 0.1,
                            pointRadius: 0,
                            // Add this to make legend show line instead of box:
                            legendColor: isSafe ? 'rgb(22, 163, 74)' : 'rgb(220, 38, 38)'
                        },
                        {
                            label: 'Target Log Reductions',
                            data: targetLogData,
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            backgroundColor: 'transparent', // No fill for target line
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cumulative Log Reductions'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: `Time (in minutes)`
                                },
                                ticks: {
                                    maxTicksLimit: 20
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Process Lethality Over Time',
                                font: {
                                    size: 18
                                }
                            },
                            // Add this custom legend plugin:
                            legend: {
                                labels: {
                                    usePointStyle: true, // This makes the legend use lines instead of boxes
                                    generateLabels: function(chart) {
                                        const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                        const labels = original.call(this, chart);
                                        
                                        // Customize the first dataset to show as line
                                        labels[0].pointStyle = 'line';
                                        labels[0].fillStyle = 'transparent'; // Remove fill in legend
                                        
                                        // Ensure second dataset shows as dashed line
                                        labels[1].pointStyle = 'line'; 
                                        labels[1].fillStyle = 'transparent';
                                        
                                        return labels;
                                    }
                                }
                            }
                        }
                    }
                });
                
                document.getElementById('chartContainer').classList.remove('hidden');

                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });


            } catch (e) {
                document.getElementById('error_message').textContent = e.message;
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('results').classList.add('hidden');
                document.getElementById('chartContainer').classList.add('hidden');
                // Scroll to error
                document.getElementById('error').scrollIntoView({ behavior: 'smooth' });
            }
        });
    </script>
</body>

</html>


